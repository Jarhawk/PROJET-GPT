-- Optional: Uncomment the following lines to drop and recreate the public schema if needed.
-- DROP SCHEMA public CASCADE;
-- CREATE SCHEMA public;

-------------------------------
-- 1. ADMIN
-------------------------------

CREATE TABLE mamas (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE roles (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    nom text NOT NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE users (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    username text NOT NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE utilisateurs (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    nom text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE permissions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    role_id uuid NOT NULL,
    user_id uuid,
    module text,
    droit text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true,
    CONSTRAINT fk_permissions_role FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    CONSTRAINT fk_permissions_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);

CREATE TABLE parametres (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    nom text,
    logo text,
    contacts jsonb,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

-------------------------------
-- 2. PRODUITS & FOURNISSEURS
-------------------------------

CREATE TABLE produits (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    nom text NOT NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE fournisseurs (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    nom text NOT NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE fournisseur_produits (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    fournisseur_id uuid NOT NULL REFERENCES fournisseurs(id) ON DELETE CASCADE,
    produit_id uuid NOT NULL REFERENCES produits(id) ON DELETE CASCADE,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE fournisseur_contacts (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    fournisseur_id uuid NOT NULL REFERENCES fournisseurs(id) ON DELETE CASCADE,
    nom text,
    email text,
    tel text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE fournisseur_notes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    fournisseur_id uuid NOT NULL REFERENCES fournisseurs(id) ON DELETE CASCADE,
    note text,
    date date,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

-------------------------------
-- 3. FACTURES / ACHATS
-------------------------------

CREATE TABLE factures (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    fournisseur_id uuid REFERENCES fournisseurs(id) ON DELETE SET NULL,
    numero text,
    date_facture date,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE facture_lignes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    facture_id uuid NOT NULL REFERENCES factures(id) ON DELETE CASCADE,
    produit_id uuid NOT NULL REFERENCES produits(id) ON DELETE CASCADE,
    quantite numeric,
    prix numeric,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

-------------------------------
-- 4. FICHES TECHNIQUES
-------------------------------

CREATE TABLE fiches (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    titre text NOT NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE fiche_lignes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    fiche_id uuid NOT NULL REFERENCES fiches(id) ON DELETE CASCADE,
    description text,
    quantite numeric,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE fiches_techniques (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    fiche_id uuid NOT NULL REFERENCES fiches(id) ON DELETE CASCADE,
    technique text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE fiche_prix_history (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    fiche_id uuid NOT NULL REFERENCES fiches(id) ON DELETE CASCADE,
    old_prix numeric,
    new_prix numeric,
    changed_by uuid,
    changed_at timestamptz,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true,
    CONSTRAINT fk_fiche_prix_history_changed_by FOREIGN KEY (changed_by) REFERENCES users(id) ON DELETE SET NULL
);

CREATE TABLE fiche_cout_history (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    fiche_id uuid NOT NULL REFERENCES fiches(id) ON DELETE CASCADE,
    old_cout numeric,
    new_cout numeric,
    changed_by uuid,
    changed_at timestamptz,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true,
    CONSTRAINT fk_fiche_cout_history_changed_by FOREIGN KEY (changed_by) REFERENCES users(id) ON DELETE SET NULL
);

-------------------------------
-- 5. STOCK
-------------------------------

CREATE TABLE zones_stock (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    nom text NOT NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE stocks (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    zone_id uuid NOT NULL REFERENCES zones_stock(id) ON DELETE CASCADE,
    produit_id uuid NOT NULL REFERENCES produits(id) ON DELETE CASCADE,
    quantite numeric,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE inventaires (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    date_inventaire date,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE inventaire_lignes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    inventaire_id uuid NOT NULL REFERENCES inventaires(id) ON DELETE CASCADE,
    produit_id uuid NOT NULL REFERENCES produits(id) ON DELETE CASCADE,
    quantite numeric,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE stock_mouvements (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    inventaire_id uuid NOT NULL REFERENCES inventaires(id) ON DELETE CASCADE,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

-- Note: Since the "pertes" table will reference "centres_de_cout", we create it next.

CREATE TABLE centres_de_cout (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    nom text NOT NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE pertes (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    produit_id uuid NOT NULL REFERENCES produits(id) ON DELETE CASCADE,
    centre_cout_id uuid REFERENCES centres_de_cout(id) ON DELETE SET NULL,
    date_perte date,
    quantite numeric,
    motif text,
    created_by uuid REFERENCES users(id) ON DELETE SET NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE transferts (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    produit_id uuid NOT NULL REFERENCES produits(id) ON DELETE CASCADE,
    quantite numeric,
    zone_depart text,
    zone_arrivee text,
    motif text,
    date_transfert date,
    created_by uuid REFERENCES users(id) ON DELETE SET NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE requisitions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    produit_id uuid NOT NULL REFERENCES produits(id) ON DELETE CASCADE,
    zone_id uuid NOT NULL REFERENCES zones_stock(id) ON DELETE CASCADE,
    date_requisition date,
    quantite numeric,
    type text,
    commentaire text,
    auteur_id uuid REFERENCES users(id) ON DELETE SET NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

-------------------------------
-- 6. MENUS / VENTES
-------------------------------

CREATE TABLE menus (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    nom text NOT NULL,
    date date,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE menu_fiches (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    menu_id uuid NOT NULL REFERENCES menus(id) ON DELETE CASCADE,
    fiche_id uuid NOT NULL REFERENCES fiches(id) ON DELETE CASCADE,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE ventes_fiches_carte (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    fiche_id uuid NOT NULL REFERENCES fiches(id) ON DELETE CASCADE,
    periode date,
    ventes integer,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE ventes_boissons (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    boisson_id uuid REFERENCES produits(id) ON DELETE SET NULL,
    quantite numeric,
    date_vente date,
    created_by uuid REFERENCES users(id) ON DELETE SET NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

-------------------------------
-- 7. ANALYSE
-------------------------------

CREATE TABLE mouvements_centres_cout (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    mouvement_id uuid,
    centre_cout_id uuid NOT NULL REFERENCES centres_de_cout(id) ON DELETE CASCADE,
    quantite numeric,
    valeur numeric,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

-------------------------------
-- 8. SUIVI / TÂCHES
-------------------------------

CREATE TABLE taches (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    titre text NOT NULL,
    description text,
    assignes uuid[],
    date_debut date,
    delai_jours integer,
    date_echeance date,
    recurrente boolean,
    frequence text,
    priorite text,
    statut text,
    created_by uuid REFERENCES users(id) ON DELETE SET NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE tache_instances (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    tache_id uuid NOT NULL REFERENCES taches(id) ON DELETE CASCADE,
    date_echeance date,
    statut text,
    done_by uuid REFERENCES users(id) ON DELETE SET NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE journal_audit (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    table_name text,
    row_id uuid,
    operation text,
    old_data jsonb,
    new_data jsonb,
    changed_by uuid REFERENCES users(id) ON DELETE SET NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true,
    changed_at timestamptz
);

CREATE TABLE journaux_utilisateur (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    action text,
    details jsonb,
    done_by uuid REFERENCES users(id) ON DELETE SET NULL,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE promotions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    nom text,
    description text,
    date_debut date,
    date_fin date,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);

CREATE TABLE promotion_produits (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    mama_id uuid NOT NULL REFERENCES mamas(id) ON DELETE CASCADE,
    promotion_id uuid NOT NULL REFERENCES promotions(id) ON DELETE CASCADE,
    produit_id uuid NOT NULL REFERENCES produits(id) ON DELETE CASCADE,
    discount numeric,
    prix_promo numeric,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    actif boolean DEFAULT true
);