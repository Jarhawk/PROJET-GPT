create or replace view v_reco_surcoût as
select distinct on (sp.product_id)
  sp.product_id,
  p.nom,
  p.mama_id,
  sp.prix_achat as dernier_prix,
  lag(sp.prix_achat) over (partition by sp.product_id order by sp.date_livraison) as prix_precedent,
  (sp.prix_achat - lag(sp.prix_achat) over (partition by sp.product_id order by sp.date_livraison))
    / nullif(lag(sp.prix_achat) over (partition by sp.product_id order by sp.date_livraison),0) * 100 as variation_pct
from supplier_products sp
join products p on p.id = sp.product_id
where p.actif = true
order by sp.product_id, sp.date_livraison desc;

grant select on v_reco_surcoût to authenticated;
